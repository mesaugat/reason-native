(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{110:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return s})),n.d(t,"metadata",(function(){return i})),n.d(t,"rightToc",(function(){return o})),n.d(t,"default",(function(){return b}));var a=n(1),r=(n(0),n(121));const s={id:"setup-teardown",title:"Setup and Teardown"},i={id:"rely/setup-teardown",title:"Setup and Teardown",description:"As of version 3.0.0, Rely provides the `beforeEach`, `beforeAll`, `afterEach`, and `afterAll` test lifecycle functions to safely perform setup and teardown operations while discouraging the usage of patterns that unsafely share state between tests.",source:"@site/../docs/rely/setup-teardown.md",permalink:"/docs/rely/setup-teardown",sidebar:"docs",previous:{title:"Rely Quickstart",permalink:"/docs/rely/quickstart"},next:{title:"Mock Functions",permalink:"/docs/rely/mock-functions"}},o=[{value:"When Lifecycle Functions are Called (and what they are called with)",id:"when-lifecycle-functions-are-called-and-what-they-are-called-with",children:[]},{value:"Passing Data to Tests",id:"passing-data-to-tests",children:[{value:"One-time setup operations",id:"one-time-setup-operations",children:[]},{value:"Repeated setup for multiple tests",id:"repeated-setup-for-multiple-tests",children:[]},{value:"Combined setup operations",id:"combined-setup-operations",children:[]}]}],l={rightToc:o},c="wrapper";function b({components:e,...t}){return Object(r.b)(c,Object(a.a)({},l,t,{components:e,mdxType:"MDXLayout"}),Object(r.b)("p",null,"As of version 3.0.0, Rely provides the ",Object(r.b)("inlineCode",{parentName:"p"},"beforeEach"),", ",Object(r.b)("inlineCode",{parentName:"p"},"beforeAll"),", ",Object(r.b)("inlineCode",{parentName:"p"},"afterEach"),", and ",Object(r.b)("inlineCode",{parentName:"p"},"afterAll")," test lifecycle functions to safely perform setup and teardown operations while discouraging the usage of patterns that unsafely share state between tests."),Object(r.b)("p",null,"In cases where teardown is not required, ",Object(r.b)("inlineCode",{parentName:"p"},"beforeEach")," and ",Object(r.b)("inlineCode",{parentName:"p"},"beforeAll")," can be helpful for code organization, but are not required to be used."),Object(r.b)("p",null,"When teardown operations are required after each test it is highly recommended to use ",Object(r.b)("inlineCode",{parentName:"p"},"afterEach")," to ensure proper exception handling behavior. ",Object(r.b)("inlineCode",{parentName:"p"},"afterAll")," is the only way to perform teardown operations after an entire test suite has executed."),Object(r.b)("h2",{id:"when-lifecycle-functions-are-called-and-what-they-are-called-with"},"When Lifecycle Functions are Called (and what they are called with)"),Object(r.b)("p",null,"All lifecycle functions are scoped to a particular describe block. Tests inside nested describes behave the same as those outside of the parent describe block (e.g. ",Object(r.b)("inlineCode",{parentName:"p"},"beforeAll")," is only called once before the outermost describe, ",Object(r.b)("inlineCode",{parentName:"p"},"beforeEach")," is called once before each test regardless of the level of nesting)."),Object(r.b)("p",null,"Within that block they work as follows:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},Object(r.b)("inlineCode",{parentName:"p"},"beforeAll")," is called once before any tests within the describe begin to execute")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},Object(r.b)("inlineCode",{parentName:"p"},"afterAll")," is called once with the return value of beforeAll after all tests within the describe have executed")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},Object(r.b)("inlineCode",{parentName:"p"},"beforeEach")," is called with the return value of beforeAll before each test is executed")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},Object(r.b)("inlineCode",{parentName:"p"},"afterEach")," is called with the return value of beforeEach after each test is executed"))),Object(r.b)("p",null,"For example:"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-reason"}),'open TestFramework;\n\nlet {describe, describeSkip, describeOnly} =\n  describeConfig\n  |> withLifecycle(testLifecycle =>\n       testLifecycle\n       |> beforeAll(() => print_endline("before all"))\n       |> afterAll(() => print_endline("after all"))\n       |> beforeEach(() => print_endline("before each"))\n       |> afterEach(() => print_endline("after each"))\n     )\n  |> build;\n\ndescribe("test lifecycle order example", ({test, describe}) => {\n  test("some test", _ =>\n    print_endline("test1")\n  );\n  test("some other test", _ =>\n    print_endline("test2")\n  );\n  describe("nested describe", ({test}) =>\n    test("nested test", _ =>\n      print_endline("nested test")\n    )\n  );\n});\n')),Object(r.b)("p",null,"outputs"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-shell"}),"before all\nbefore each\ntest1\nafter each\nbefore each\ntest2\nafter each\nbefore each\nnested test\nafter each\nafter all\n")),Object(r.b)("h2",{id:"passing-data-to-tests"},"Passing Data to Tests"),Object(r.b)("p",null,"Often a goal of test setup is to make some external resource such as a testing database or a temp directory available for use in individual tests."),Object(r.b)("p",null,"The return value of ",Object(r.b)("inlineCode",{parentName:"p"},"beforeEach"),' is made available via the "env" field that tests have access to. ',Object(r.b)("inlineCode",{parentName:"p"},"beforeEach")," is passed the return value of ",Object(r.b)("inlineCode",{parentName:"p"},"beforeAll")," (the default implementation of beforeAll just returns unit)."),Object(r.b)("p",null,"If ",Object(r.b)("inlineCode",{parentName:"p"},"beforeEach")," is not used, the identity function is used. Consequently ",Object(r.b)("strong",{parentName:"p"},'in the absence of a user specified beforeEach function, the return value of beforeAll is passed via the "env" field of the test record'),"."),Object(r.b)("p",null,"If neither beforeEach nor beforeAll are specified, env is bound to unit and can safely be ignored."),Object(r.b)("h3",{id:"one-time-setup-operations"},"One-time setup operations"),Object(r.b)("p",null,"Sometimes a single setup step is sufficient for a test suite. This can happen when establishing a connection to some external resource that can be shared across individual tests without consequence."),Object(r.b)("p",null,"Suppose for example that we are testing a web scraping utility and need to both start and stop a test server for use in our tests."),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-reason"}),'open TestFramework;\n\nlet {describe, describeSkip, describeOnly} =\n  describeConfig\n  |> withLifecycle(testLifecycle =>\n       testLifecycle\n       |> beforeAll(() => TestServer.start())\n       |> afterAll(server => TestServer.stop(server))\n     )\n  |> build;\n\ndescribe("My web scraper", ({test}) => {\n  test("My snapshot test", ({expect, env}) => {\n    let result = MyWebScraper.scrape(server.baseUrl);\n\n    expect.string(result).toMatchSnapshot();\n  })\n  ...\n});\n')),Object(r.b)("h3",{id:"repeated-setup-for-multiple-tests"},"Repeated setup for multiple tests"),Object(r.b)("p",null,"Suppose that we wish to test a calendar application that interacts with a database of important historical events. Each test needs access to a fresh copy of a testing database."),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-reason"}),'let {describe, describeSkip, describeOnly} =\n  describeConfig\n  |> withLifecycle(testLifecycle =>\n       testLifecycle\n       |> beforeEach(() => EventsDB.initializeTestDatabase())\n       |> afterEach(db => EventsDB.dispose(db))\n     )\n  |> build;\n\ndescribe("My calendar app", ({test}) => {\n  test("adding a historical event", ({expect, env})\n    => {\n      let calendar = MyCalendarApp.init(env);\n      let initialEvents = calendar.getHistoricalEvents(2016, 11, 2);\n\n      let testEvent =\n        historicalEventBuilder\n        |> withDate(2016, 11, 2)\n        |> withDescription("Chicago Cubs win the World Series")\n        |> build;\n\n      calendar.add(testEvent);\n\n      let resultingEvents = calendar.getHistoricalEvents(2016, 11, 2);\n\n      expect.int(List.length(resultingEvents)).toBe(\n        List.length(initialEvents) + 1,\n      );\n    })\n    ...\n});\n')),Object(r.b)("h3",{id:"combined-setup-operations"},"Combined setup operations"),Object(r.b)("p",null,"Sometimes there are setup operations you want to do once before any tests execute as well as operations that you want to do before each test executes."),Object(r.b)("p",null,"Suppose that we have a chatbot application that we want to test. We need to resolve the chatbot's credentials (which we can reuse) from a secure location because we don't want to source control them, but we want to ensure that each test runs in a separate session."),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-reason"}),'open TestFramework;\n\ntype testData = {session: ChatBot.session};\n\nlet {describe, describeSkip, describeOnly} =\n  describeConfig\n  |> withLifecycle(testLifecycle =>\n       testLifecycle\n       |> beforeAll(() => resolveChatbotCredentials())\n       |> beforeEach(credentials => {\n            let session = ChatBotAPI.login(credentials);\n            session;\n          })\n     )\n  |> afterEach(session => session.close())\n  |> build;\n\ndescribe("My chat bot", ({test}) => {\n  test("My test", ({expect, env}) => {\n    let myChatBot = MyChatBot.init(env.session);\n\n    myChatBot.message(MyChatBot.user, "hello self!");\n    let receivedMessages = myChatBot.getReceivedMessages();\n\n    expect.list(receivedMessages).toContain("hello self!");\n  })\n});\n')))}b.isMDXComponent=!0},121:function(e,t,n){"use strict";n.d(t,"a",(function(){return p})),n.d(t,"b",(function(){return h}));var a=n(0),r=n.n(a);function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},s=Object.keys(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var c=r.a.createContext({}),b=function(e){var t=r.a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):o({},t,{},e)),n},p=function(e){var t=b(e.components);return r.a.createElement(c.Provider,{value:t},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},f=Object(a.forwardRef)((function(e,t){var n=e.components,a=e.mdxType,s=e.originalType,i=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),p=b(n),d=a,f=p["".concat(i,".").concat(d)]||p[d]||u[d]||s;return n?r.a.createElement(f,o({ref:t},c,{components:n})):r.a.createElement(f,o({ref:t},c))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var s=n.length,i=new Array(s);i[0]=f;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o[d]="string"==typeof e?e:a,i[1]=o;for(var c=2;c<s;c++)i[c]=n[c];return r.a.createElement.apply(null,i)}return r.a.createElement.apply(null,n)}f.displayName="MDXCreateElement"}}]);